# Система вариантов товаров

## Описание

Система позволяет создавать товары с несколькими вариантами (например, разные цвета устройств). Каждый вариант имеет:
- Свое название
- Код цвета (для отображения)
- Собственные изображения
- Опциональную цену (если отличается от основной)
- Свой остаток на складе

## База данных

### Таблица `product_variants`
```sql
CREATE TABLE product_variants (
  id TEXT PRIMARY KEY,
  product_id TEXT NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  color_code TEXT,
  price_rub INTEGER,
  stock INTEGER DEFAULT 0,
  position INTEGER NOT NULL DEFAULT 0,
  created_at TEXT NOT NULL DEFAULT (DATETIME('now')),
  UNIQUE(product_id, name)
)
```

### Обновление `products`
- Добавлено поле `has_variants` (INTEGER, 0/1)

### Обновление `product_images`
- Добавлено поле `variant_id` (TEXT, NULL для обычных товаров)

## API

### Создание товара с вариантами

**POST** `/api/admin/products`

```json
{
  "categoryId": "c_pods",
  "title": "VOOPOO Drag Nano 2",
  "priceRub": 0,
  "description": "Компактная POD-система",
  "hasVariants": true,
  "variants": [
    {
      "name": "Черный",
      "colorCode": "#000000",
      "priceRub": 1990,
      "stock": 25,
      "images": ["/uploads/temp/image1.jpg"]
    },
    {
      "name": "Синий",
      "colorCode": "#0ea5e9",
      "priceRub": 1990,
      "stock": 18,
      "images": ["/uploads/temp/image2.jpg"]
    }
  ]
}
```

### Получение товара с вариантами

**GET** `/api/products` или `/api/product/:id`

Ответ включает:
```json
{
  "id": "p_123",
  "title": "VOOPOO Drag Nano 2",
  "hasVariants": true,
  "variants": [
    {
      "id": "v_abc123",
      "name": "Черный",
      "colorCode": "#000000",
      "priceRub": 1990,
      "stock": 25,
      "images": ["url1", "url2"]
    }
  ]
}
```

## Использование в админке

1. При создании товара включите чекбокс "Товар с вариантами"
2. Нажмите "+ Добавить вариант"
3. Для каждого варианта укажите:
   - Название (например, "Черный", "Синий градиент")
   - Код цвета (через color picker или вручную в формате #RRGGBB)
   - Цену (опционально, если отличается)
   - Остаток на складе
   - Загрузите изображения для этого варианта

## Отображение в витрине

### Desktop
- Селектор вариантов отображается как сетка цветных кружков с названиями
- При выборе варианта меняются изображения и цена
- Статус наличия обновляется на основе остатка варианта

### Mobile
- Горизонтальная прокрутка вариантов под галереей изображений
- Название выбранного варианта отображается в нижней панели
- При выборе автоматически переключаются изображения

## Корзина

Товар с вариантом добавляется в корзину с указанием:
- `variantId` - ID выбранного варианта
- `variantName` - название варианта
- Цена и изображение берутся из варианта

Один и тот же товар с разными вариантами считается как разные позиции в корзине.

## Пример seed-данных

См. файл `server/seed/products_with_variants_example.json` - пример товара VOOPOO Drag Nano 2 с 5 цветовыми вариантами.

## Обратная совместимость

- Обычные товары без вариантов работают как прежде
- Жидкости с использованием изображения категории не затронуты
- Все существующие товары остаются без изменений (has_variants = 0)

## Тестирование

### Сценарии для проверки:

1. **Создание товара с вариантами**
   - Проверить загрузку изображений для каждого варианта
   - Убедиться, что сохраняются все данные (цена, остаток, цвет)

2. **Редактирование товара с вариантами**
   - Добавление нового варианта
   - Удаление варианта
   - Изменение изображений варианта

3. **Отображение в витрине**
   - Проверить переключение между вариантами
   - Убедиться, что меняются изображения и цена
   - Проверить на мобильной и десктопной версии

4. **Корзина**
   - Добавить разные варианты одного товара
   - Проверить, что они отображаются как отдельные позиции
   - Проверить правильность цен

5. **Обратная совместимость**
   - Убедиться, что обычные товары работают корректно
   - Проверить жидкости с группами
   - Проверить товары с изображением категории

## Ограничения

- Минимум 1 вариант для товара с вариантами
- Каждый вариант должен иметь минимум 1 изображение
- Название варианта обязательно
- Код цвета опционален (по умолчанию серый)
- Цена варианта опциональна (используется priceRub товара)
