# Обновление системы остатков для товаров с вариантами

## Дата: 2025-11-03

## Описание изменений

Реализована полноценная поддержка остатков для товаров с несколькими вариантами (например, POD устройства разных цветов).

## Что было изменено

### 1. Backend (server/routes/admin.js)

#### GET /api/admin/products
- Добавлен расчет `minVariantStock` и `maxVariantStock` для товаров с вариантами
- Эти поля используются для отображения диапазона остатков в таблице товаров

#### GET /api/admin/products/:id
- Аналогичный расчет для отдельного товара

### 2. Backend (server/routes/crm-finance.js)

#### GET /api/admin/crm/products/low-stock
**ВАЖНОЕ ИЗМЕНЕНИЕ**: Теперь возвращает **варианты как отдельные товары**, а не весь товар целиком.

**Логика:**
- Для обычных товаров: возвращается товар, если `stock <= min_stock`
- Для товаров с вариантами: возвращается **каждый вариант отдельно**, если его остаток `<= min_stock`

**Формат данных варианта:**
```javascript
{
  id: "v_abc123",           // ID варианта
  product_id: "p_xyz789",   // ID базового товара
  title: "X-ROS 2 (Черный)", // Название с цветом
  variant_name: "Черный",
  stock: 2,                  // Остаток конкретного варианта
  min_stock: 5,
  is_variant: true
}
```

### 3. Frontend (AdminProductForm.vue)

#### Поле minStock
- Теперь отображается **всегда** (для обычных товаров и товаров с вариантами)
- Для товаров с вариантами: порог применяется к каждому варианту индивидуально
- Добавлена динамическая подсказка в зависимости от типа товара

#### Отправка данных
- `minStock` отправляется в payload независимо от наличия вариантов

### 4. Frontend (AdminProductsTable.vue)

#### Отображение остатков
- **Обычные товары**: показывается остаток как раньше
- **Товары с вариантами**: показывается диапазон `мин–макс` или единое значение, если все варианты имеют одинаковый остаток

Примеры:
- `14 шт` - все варианты имеют остаток 14
- `2–14 шт` - минимальный остаток 2, максимальный 14

#### Подсветка низких остатков
- Для товаров с вариантами проверяется минимальный остаток из всех вариантов
- Если хотя бы один вариант ниже порога - строка подсвечивается красным

#### Сортировка
- При сортировке по остатку товары с вариантами сортируются по минимальному остатку

### 5. Frontend (CrmProcurements.vue)

#### Отображение в закупках
- Варианты показываются как **отдельные позиции** с названием типа "X-ROS 2 (Черный)"
- В колонке "Остаток" показывается остаток конкретного варианта

#### Логика добавления в закупку
- При добавлении варианта сохраняется:
  - `id` - ID варианта (для уникальности в UI)
  - `productId` - ID базового товара (для сохранения в БД)

#### Сохранение закупки
- В БД сохраняется `productId` (ID базового товара), а не ID варианта
- Это правильно, т.к. остатки хранятся на уровне варианта, но в закупках нужен базовый товар

### 6. TypeScript интерфейсы

#### CrmProductSummary (stores/crm.ts)
Добавлены новые поля:
```typescript
interface CrmProductSummary {
  id: string
  productId?: string        // Для вариантов - ID базового товара
  isVariant?: boolean       // Флаг варианта
  variantName?: string      // Название цвета
  // ... остальные поля
}
```

## Как работает

### Сценарий 1: Обычный товар (без вариантов)
1. Товар "Жидкость 30ml" имеет `stock = 5`, `min_stock = 10`
2. В таблице товаров показывается: "5 шт (мин. 10)"
3. Строка подсвечена красным
4. В разделе "Закупки" товар появляется в списке "Товары в зоне риска"

### Сценарий 2: Товар с вариантами
1. Товар "X-ROS 2" с вариантами:
   - Черный: `stock = 2`
   - Синий: `stock = 14`
   - `min_stock = 5` (общий порог)

2. В таблице товаров:
   - Показывается: "2–14 шт (мин. 5)"
   - Строка подсвечена красным (т.к. минимальный остаток 2 < 5)

3. В разделе "Закупки":
   - В списке "Товары в зоне риска" появляется только "X-ROS 2 (Черный)" с остатком 2
   - "X-ROS 2 (Синий)" НЕ появляется (его остаток 14 > 5)

4. При добавлении "X-ROS 2 (Черный)" в закупку:
   - В UI показывается как отдельная позиция
   - При сохранении остаток обновляется для базового товара

## Тестирование

### Проверить обычные товары:
1. Создать товар без вариантов с низким остатком
2. Убедиться, что показывается в закупках
3. Добавить в закупку и завершить - остаток должен увеличиться

### Проверить товары с вариантами:
1. Создать товар с 2-3 вариантами
2. Установить разные остатки для вариантов (один ниже порога, другие выше)
3. В таблице товаров должен показываться диапазон остатков
4. В закупках должны появиться только варианты с низким остатком
5. Добавить вариант в закупку и завершить - остаток базового товара должен увеличиться

## Известные ограничения

1. Минимальный порог (`min_stock`) - единый для всего товара, не для каждого варианта отдельно
2. При закупке варианта обновляется остаток базового товара (не варианта напрямую)

## Совместимость

Все изменения обратно совместимы:
- Обычные товары работают как раньше
- Старые товары с вариантами получат корректное отображение остатков автоматически
